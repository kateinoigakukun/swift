variables:
  system.debug: true
jobs:
- job: Ubuntu
  timeoutInMinutes: 0
  pool:
    vmImage: 'Ubuntu-16.04'
  steps:
  - script: |
      sudo apt update
      sudo apt install \
        git ninja-build clang python \
        uuid-dev libicu-dev icu-devtools libbsd-dev \
        libedit-dev libxml2-dev libsqlite3-dev swig \
        libpython-dev libncurses5-dev pkg-config \
        libblocksruntime-dev libcurl4-openssl-dev \
        systemtap-sdt-dev tzdata rsync
    displayName: Install dependencies via apt-get
  - script: |
      wget -O install_cmake.sh "https://github.com/Kitware/CMake/releases/download/v3.15.3/cmake-3.15.3-Linux-x86_64.sh"
      chmod +x install_cmake.sh
      sudo mkdir -p /opt/cmake
      sudo ./install_cmake.sh --skip-license --prefix=/opt/cmake
      sudo ln -sf /opt/cmake/bin/* /usr/local/bin
      cmake --version
    displayName: Install CMake v3.15.3
  - script: |
      mkdir -p swift-source/swift
    displayName: Create swift-source workspace
    workingDirectory: $(Pipeline.Workspace)
  - checkout: self
    path: swift-source/swift
  - script: |
      wget -O wasisdk.deb "https://github.com/swiftwasm/wasi-sdk/releases/download/20190421.6/wasi-sdk_3.19gefb17cb478f9.m_amd64.deb"
      sudo dpkg -i wasisdk.deb
      wget -O icu.tar.xz "https://github.com/swiftwasm/icu4c-wasi/releases/download/20190421.3/icu4c-wasi.tar.xz"
      tar xf icu.tar.xz
    workingDirectory: $(Pipeline.Workspace)/swift-source
    displayName: Install wasi-sdk and icu4c-wasi
  - script: |
      sourcedir="$PWD"
      cd swift
      utils/update-checkout --clone --scheme wasm
      git checkout $BUILD_SOURCEBRANCHNAME
      utils/build-script --release --wasm \
        --llvm-targets-to-build "X86;WebAssembly" \
        --build-swift-dynamic-sdk-overlay false \
        --build-swift-static-sdk-overlay false \
        --wasm-wasi-sdk "/opt/wasi-sdk" \
        --wasm-icu-uc "todo" \
        --wasm-icu-uc-include "$sourcedir/icu_out/include" \
        --wasm-icu-i18n "todo" \
        --wasm-icu-i18n-include "todo" \
        --wasm-icu-data "todo" \
        --build-swift-static-stdlib \
        --install-swift \
        --install-prefix="/opt/swiftwasm-sdk" \
        --install-destdir="$sourcedir/install" \
        --installable-package="$sourcedir/swiftwasm.tar.gz"
        cp "$sourcedir/swiftwasm.tar.gz" "$BUILD_ARTIFACTSTAGINGDIRECTORY/"
    displayName: Build swiftc
    timeoutInMinutes: 0
    workingDirectory: $(Pipeline.Workspace)/swift-source
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: swiftwasm-sdk
  - task: GitHubRelease@0
    inputs:
      gitHubConnection: swiftwasm-release
      tagSource: manual
      tag: $(Build.BuildNumber)
      assets: |
        $(Build.ArtifactStagingDirectory)/*

- job: macOS
  timeoutInMinutes: 0
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - script: |
      brew install ninja

    displayName: Install dependencies via apt-get
  - script: |
      wget -O cmake-3.15.3-Darwin-x86_64.tar.gz "https://github.com/Kitware/CMake/releases/download/v3.15.3/cmake-3.15.3-Linux-x86_64.s://github.com/Kitware/CMake/releases/download/v3.15.3/cmake-3.15.3-Darwin-x86_64.tar.gz"
      tar xfvz cmake-3.15.3-Darwin-x86_64.tar.gz
      sudo ln -sf ./cmake-3.15.3-Darwin-x86_64/CMake.app/Contents/bin/* /usr/local/bin
      cmake --version
    displayName: Install CMake v3.15.3
  - script: |
      mkdir -p swift-source/swift
    displayName: Create swift-source workspace
    workingDirectory: $(Pipeline.Workspace)
  - checkout: self
    path: swift-source/swift
  - script: |
      wget -O wasi-sdk.tar.gz https://github.com/swiftwasm/wasi-sdk/releases/download/20190421.6/wasi-sdk-3.19gefb17cb478f9.m-linux.tar.gz
      tar xfz wasi-sdk.tar.gz
      mv wasi-sdk-3.19gefb17cb478f9+m/opt/wasi-sdk ./wasi-sdk
      # Link sysroot/usr/include to sysroot/include because Darwin sysroot doesn't 
      # find header files in sysroot/include but sysroot/usr/include
      mkdir wasi-sdk/share/sysroot/usr/
      ln -s ../include wasi-sdk/share/sysroot/usr/include
      wget -O icu.tar.xz "https://github.com/swiftwasm/icu4c-wasi/releases/download/20190421.3/icu4c-wasi.tar.xz"
      tar xf icu.tar.xz
    workingDirectory: $(Pipeline.Workspace)/swift-source
    displayName: Install wasi-sdk and icu4c-wasi
  - script: |
      sourcedir="$PWD"
      cd swift
      utils/update-checkout --clone --scheme wasm
      git checkout $BUILD_SOURCEBRANCHNAME
      utils/build-script --release --wasm \
        --verbose \
        --skip-build-benchmarks \
        --llvm-targets-to-build "X86;WebAssembly" \
        --wasm-wasi-sdk "$sourcedir/wasi-sdk" \
        --wasm-icu-uc "todo" \
        --wasm-icu-uc-include "$sourcedir/icu_out/include" \
        --wasm-icu-i18n "todo" \
        --wasm-icu-i18n-include "todo" \
        --wasm-icu-data "todo" \
        --build-swift-static-stdlib \
        --install-swift \
        --install-prefix="/opt/swiftwasm-sdk" \
        --install-destdir="$sourcedir/install" \
        --installable-package="$sourcedir/swiftwasm-mac.tar.gz"

        cp "$sourcedir/swiftwasm-mac.tar.gz" "$BUILD_ARTIFACTSTAGINGDIRECTORY/"
    displayName: Build swiftc
    timeoutInMinutes: 0
    workingDirectory: $(Pipeline.Workspace)/swift-source
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: swiftwasm-sdk
  - task: GitHubRelease@0
    inputs:
      gitHubConnection: swiftwasm-release
      tagSource: manual
      tag: $(Build.BuildNumber)
      assets: |
        $(Build.ArtifactStagingDirectory)/*
